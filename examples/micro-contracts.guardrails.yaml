# AI-Driven Development Guardrails Configuration
# 
# This file defines which files can be modified in normal development PRs.
# Patterns use gitignore-style matching with glob patterns.
# Prefix with ! to negate (exclude) a pattern.

# Files that can be edited in normal development PRs
allowed:
  # OpenAPI specs (source of truth)
  - spec/**/openapi/*.yaml
  - spec/**/templates/*.hbs
  
  # Domain implementations (human-written)
  - server/src/**/domains/**/*.ts
  - server/src/**/container.ts
  - server/src/server.ts
  
  # Module-specific overlays (NOT _shared)
  - server/src/*/overlays/**/*.ts
  - "!server/src/_shared/overlays/**"
  
  # Configuration
  - micro-contracts.config.yaml
  - package.json
  - tsconfig.json
  
  # Documentation
  - docs/**/*.md
  - README.md

# Files that require special approval
protected:
  # Spectral lint rules
  - spec/spectral.yaml
  - spec/_shared/spectral.yaml
  
  # Shared overlay definitions
  - spec/_shared/overlays/**
  
  # Shared security overlay implementations
  - server/src/_shared/overlays/**
  
  # This guardrails configuration
  - micro-contracts.guardrails.yaml
  
  # CI/workflow definitions
  - .github/**

# Generated artifacts (committed, but only modified via generate)
generated:
  # Contract packages
  - packages/**
  
  # Generated files
  - "**/*.generated.ts"
  - "**/*.generated.yaml"
  - "**/*.generated.yml"

# Check command configurations
# Define custom commands for each guardrail check
#
# Based on guardrails-concept.svg:
#
# Gate 1: Change Allowlist
#   - allowlist (built-in): packages/** edit blocked, *.generated.* edit blocked
#
# Gate 2: OpenAPI Contract Validation (Spectral)
#   - spec-lint: Schema Validity, x-security Required, x-auth Declaration
#   - spec-breaking: Breaking Changes detection (oasdiff)
#
# Gate 3: Generated Artifact Integrity
#   - drift (built-in): git diff packages/**
#   - manifest (built-in): SHA-256 verification
#   - package-typecheck: Generated package type check
#
# Gate 4: Code Quality
#   - code-lint: TypeScript Lint (ESLint)
#   - code-typecheck: Type Check (tsc)
#   - code-test: Unit Tests
#
# Gate 5: Doc Consistency & Static Analysis
#   - docs-sync: Markdown Sync (embedoc)
#   - docs-links: Links Valid
#   - security (built-in): CodeQL static analysis
#
# Placeholders:
#   {files} - space-separated list of target files (auto-detected)
#   {cwd} - current working directory

checks:
  # ==========================================
  # Gate 2: OpenAPI Contract Validation
  # ==========================================
  # Schema Validity, x-security Required, x-auth Declaration, Description Check
  spec-lint:
    command: "npx @stoplight/spectral-cli lint {files} --ruleset spec/spectral.yaml"
  
  # Breaking Changes detection (oasdiff)
  # Compare current spec against main branch
  # Uses bundled spec to resolve $refs properly
  #
  # NOTE: Replace the base path with your actual generated spec location:
  #   Recommended: main:packages/contract/<module>/docs/openapi.generated.yaml
  #   Example below uses: main:examples/packages/... (for this repo's structure)
  spec-breaking:
    command: "bash -c 'npx @redocly/cli bundle spec/core/openapi/core.yaml -o /tmp/current.yaml && git show main:examples/packages/contract/core/docs/openapi.generated.yaml > /tmp/base.yaml 2>/dev/null && oasdiff breaking /tmp/base.yaml /tmp/current.yaml --fail-on ERR || echo \"No base spec found (new file)\"'"

  # ==========================================
  # Gate 3: Generated Artifact Integrity
  # ==========================================
  # drift, manifest are built-in checks
  
  # Generated package type check
  package-typecheck:
    command: "cd packages/contract && npx tsc --noEmit"

  # ==========================================
  # Gate 4: Code Quality
  # ==========================================
  # TypeScript Lint (ESLint)
  code-lint:
    command: "cd server && npx eslint src/ --ext .ts && cd ../frontend && npx eslint src/ --ext .ts,.tsx"
  
  # Type Check (tsc)
  code-typecheck:
    command: "cd server && npx tsc --noEmit && cd ../frontend && npx tsc --noEmit"
  
  # Unit Tests
  code-test:
    command: "cd server && npm test && cd ../frontend && npm test"
    enabled: false  # Enable when tests are set up

  # ==========================================
  # Gate 5: Doc Consistency & Static Analysis
  # ==========================================
  # Markdown Sync (embedoc) - regenerate and check for drift
  docs-sync:
    command: "npx embedoc build && git diff --exit-code docs/"
    enabled: false  # Enable when docs/ directory exists
  
  # Links Valid - verify documentation references
  docs-links:
    command: "node scripts/verify-doc-consistency.mjs"
    enabled: false  # Enable when scripts/verify-doc-consistency.mjs exists
  