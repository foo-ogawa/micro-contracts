# Cross-cutting concerns overlay
# Injects parameters and responses based on x-middleware markers
overlay: 1.0.0
info:
  title: Middleware Extension Overlay
  version: 1.0.0
  description: |
    This overlay injects cross-cutting concerns based on x-middleware markers:
    - requireAuth: Adds Authorization header + 401 response
    - requireAdmin: Adds 401 + 403 responses  
    - tenantIsolation: Adds X-Tenant-Id header + 400 response
    - rateLimit: Adds X-RateLimit-Limit header + 429 response

# Cautions (implementation notes)
# This data is auto-synced to README.md via embedoc
x-micro-contracts-cautions:
  - id: auth-token-format
    severity: warning
    title: "Auth Token Format"
    message: |
      Send the `Authorization` header in `Bearer <token>` format.
      Accessing without a token returns 401 Unauthorized.

  - id: tenant-isolation
    severity: error
    title: "Tenant Isolation Requirement"
    message: |
      Endpoints using `tenantIsolation` middleware require
      the `X-Tenant-Id` header to be sent.
      Missing header returns 400 Bad Request.

  - id: rate-limit-handling
    severity: info
    title: "Rate Limit Handling"
    message: |
      For endpoints with `rateLimit` middleware,
      check the `X-RateLimit-Remaining` response header.
      When limit is exceeded, 429 Too Many Requests is returned
      with `Retry-After` header indicating retry time.

  - id: admin-endpoints
    severity: warning
    title: "Admin Endpoint Access Control"
    message: |
      Endpoints with `requireAdmin` middleware are accessible
      only to users with admin role (`role: admin`).
      Non-admin users receive 403 Forbidden.

actions:
  # ==========================================================================
  # requireAuth: Authentication required
  # ==========================================================================
  - target: "$.paths[*][*][?(@.x-middleware contains 'requireAuth')]"
    x-micro-contracts-overlay-name: requireAuth
    description: Inject Authorization header and 401 response for authenticated endpoints
    update:
      parameters:
        - name: Authorization
          in: header
          required: false
          schema:
            type: string
          description: Bearer token for authentication
      responses:
        '401':
          $ref: '../openapi/problem-details.yaml#/components/responses/Unauthorized'

  # ==========================================================================
  # requireAdmin: Admin role required
  # ==========================================================================
  - target: "$.paths[*][*][?(@.x-middleware contains 'requireAdmin')]"
    x-micro-contracts-overlay-name: requireAdmin
    description: Inject 401 + 403 responses for admin endpoints
    update:
      responses:
        '401':
          $ref: '../openapi/problem-details.yaml#/components/responses/Unauthorized'
        '403':
          $ref: '../openapi/problem-details.yaml#/components/responses/Forbidden'

  # ==========================================================================
  # tenantIsolation: Multi-tenant isolation
  # ==========================================================================
  - target: "$.paths[*][*][?(@.x-middleware contains 'tenantIsolation')]"
    x-micro-contracts-overlay-name: tenantIsolation
    description: Inject X-Tenant-Id header and 400 response for tenant-scoped endpoints
    update:
      parameters:
        - name: X-Tenant-Id
          in: header
          required: true
          schema:
            type: string
            format: uuid
          description: Tenant identifier for multi-tenant isolation
      responses:
        '400':
          description: Missing or invalid X-Tenant-Id header
          content:
            application/problem+json:
              schema:
                $ref: '../openapi/problem-details.yaml#/components/schemas/ProblemDetails'

  # ==========================================================================
  # rateLimit: Rate limiting
  # ==========================================================================
  - target: "$.paths[*][*][?(@.x-middleware contains 'rateLimit')]"
    x-micro-contracts-overlay-name: rateLimit
    description: Inject rate limit headers and 429 response
    update:
      parameters:
        - name: X-RateLimit-Limit
          in: header
          schema:
            type: integer
          description: Rate limit ceiling for this endpoint (response header)
        - name: X-RateLimit-Remaining
          in: header
          schema:
            type: integer
          description: Remaining requests in current window (response header)
      responses:
        '429':
          $ref: '../openapi/problem-details.yaml#/components/responses/TooManyRequests'
