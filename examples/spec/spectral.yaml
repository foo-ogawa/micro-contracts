# Spectral Lint Rules for micro-contracts
# Global rules applied to all modules

extends:
  - spectral:oas

rules:
  # ==========================================================================
  # micro-contracts specific rules
  # ==========================================================================
  
  # Require x-micro-contracts-domain on all operations
  operation-domain:
    description: Operations must have x-micro-contracts-domain
    severity: error
    given: "$.paths[*][get,post,put,patch,delete]"
    then:
      field: x-micro-contracts-domain
      function: truthy

  # Require x-micro-contracts-method on all operations
  operation-method:
    description: Operations must have x-micro-contracts-method
    severity: error
    given: "$.paths[*][get,post,put,patch,delete]"
    then:
      field: x-micro-contracts-method
      function: truthy

  # Enforce canonical extension prefix
  canonical-extension-prefix:
    description: Use x-micro-contracts-* prefix (not x-domain, x-method, etc.)
    severity: error
    given: "$.paths[*][get,post,put,patch,delete]"
    then:
      function: schema
      functionOptions:
        schema:
          not:
            anyOf:
              - required: [x-domain]
              - required: [x-method]
              - required: [x-public]
              - required: [x-private]

  # Public endpoints cannot reference private schemas
  no-non-exportable-in-published:
    description: Public endpoints cannot reference x-micro-contracts-non-exportable schemas
    severity: error
    given: "$.paths[*][get,post,put,patch,delete][?(@['x-micro-contracts-published'] == true)]..schema.$ref"
    then:
      function: pattern
      functionOptions:
        notMatch: "x-micro-contracts-non-exportable"

  # ==========================================================================
  # Overlay target rules
  # ==========================================================================
  
  # Overlay targets must be analyzable
  overlay-analyzable-target:
    description: Overlay targets must be analyzable for Extension IF generation
    severity: error
    given: "$.actions[*].target"
    then:
      function: pattern
      functionOptions:
        match: >-
          ^\$\.paths\[\*\]\[\*\]\[\?\(@\.(x-[a-z-]+)(\s+contains\s+'[^']+')?\)\]$

