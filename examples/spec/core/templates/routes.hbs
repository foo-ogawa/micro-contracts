/**
 * Auto-generated Fastify routes
 * Generated from: {{spec.info.title}} v{{spec.info.version}}
 * DO NOT EDIT MANUALLY
 */

import type { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';
import { allSchemas } from '{{contractPackage}}/schemas/index.js';
import * as types from '{{contractPackage}}/schemas/types.js';
{{#if extensionInfo.length}}
import { runOverlays, toHttpRequest, sendError } from './overlayAdapter.generated.js';
{{/if}}

export async function registerRoutes(fastify: FastifyInstance): Promise<void> {
  for (const schema of allSchemas) {
    fastify.addSchema(schema);
  }

  const { {{#each domains}}{{key}}{{#unless @last}}, {{/unless}}{{/each}} } = {{domainsPath}};
{{#if extensionInfo.length}}
  const handlers = fastify.overlayHandlers;
{{/if}}

{{#each routes}}
  // {{uppercase method}} {{path}}{{#if isPublished}} [PUBLISHED]{{/if}}
  fastify.{{method}}('{{fastifyPath}}', {
    schema: {
{{#if pathParams.length}}
      params: { $ref: '{{typeNameBase}}Params#' },
{{/if}}
{{#if queryParams.length}}
      querystring: { $ref: '{{typeNameBase}}Params#' },
{{/if}}
{{#if requestBody}}
      body: { $ref: '{{requestBody.schemaName}}#' },
{{/if}}
{{#if responses.length}}
      response: { {{#each responses}}{{#if schemaName}}{{statusCode}}: { $ref: '{{schemaName}}#' }{{#unless @last}}, {{/unless}}{{/if}}{{/each}} },
{{/if}}
    },
  }, async (req: FastifyRequest, reply: FastifyReply) => {
{{#if extensions.length}}
    const result = await runOverlays('{{operationId}}', handlers, toHttpRequest(req));
    if (!result.success) return sendError(reply, result.error);
{{/if}}
    // Build input object (always required, even if empty)
    const input: types.{{inputType}} = {
{{#if pathParams.length}}
      ...(req.params as types.{{typeNameBase}}Params),
{{/if}}
{{#if queryParams.length}}
      ...(req.query as types.{{typeNameBase}}Params),
{{/if}}
{{#if requestBody}}
      data: req.body as types.{{requestBody.schemaName}},
{{/if}}
    };
    return {{domainKey}}.{{domainMethod}}(input);
  });

{{/each}}
}
